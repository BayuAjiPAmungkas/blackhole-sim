<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Black Hole + Rocket — Mobile Lite</title>
<style>
  html,body{height:100%;margin:0;background:#000;color:#e8eef6;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;touch-action:none}
  #wrap{position:relative;height:100vh;overflow:hidden;background:radial-gradient(900px 600px at 50% 50%,#07090f,#000)}
  canvas{position:absolute;inset:0;width:100%;height:100%;display:block}
  .hud{position:absolute;left:10px;top:10px;z-index:5;font-size:12px;bac<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Black Hole + Rocket — Stable Build</title>
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      background: #000;
      color: #e8eef6;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      touch-action: none
    }

    #wrap {
      position: relative;
      height: 100vh;
      overflow: hidden;
      background: radial-gradient(800px 520px at 50% 50%, #07090f, #000)
    }

    canvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      display: block
    }

    /* HUD + badge */
    .hud {
      position: absolute;
      left: 10px;
      top: 10px;
      z-index: 6;
      font-size: 12px;
      background: rgba(0, 0, 0, .35);
      padding: 6px 8px;
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, .08)
    }

    .badge {
      position: absolute;
      left: 10px;
      top: 42px;
      z-index: 6;
      font-size: 11px;
      background: #1b2333;
      color: #cfe9ff;
      border: 1px solid rgba(121, 198, 255, .4);
      padding: 3px 6px;
      border-radius: 8px
    }

    /* Menu */
    .menu {
      position: absolute;
      right: 10px;
      top: 10px;
      z-index: 7
    }

    .btn {
      padding: 6px 10px;
      border-radius: 10px;
      background: rgba(12, 18, 28, .8);
      border: 1px solid rgba(255, 255, 255, .15);
      cursor: pointer;
      user-select: none
    }

    .panel {
      margin-top: 8px;
      background: rgba(10, 10, 20, .85);
      border: 1px solid rgba(255, 255, 255, .12);
      border-radius: 12px;
      padding: 8px;
      display: none;
      width: min(360px, 92vw)
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 70px;
      gap: 8px;
      align-items: center;
      margin: 6px 0
    }

    .row input[type=range] {
      -webkit-appearance: none;
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: linear-gradient(90deg, #79c6ff, #aabfff);
      outline: none
    }

    .tog {
      display: flex;
      gap: 8px;
      align-items: center;
      font-size: 12px;
      background: rgba(255, 255, 255, .06);
      border: 1px solid rgba(255, 255, 255, .1);
      padding: 6px 8px;
      border-radius: 10px
    }

    /* Touch controls */
    .touch {
      position: absolute;
      inset: 0;
      z-index: 5;
      pointer-events: none
    }

    .joy {
      position: absolute;
      left: 12px;
      bottom: 12px;
      width: 140px;
      height: 140px;
      border-radius: 50%;
      background: rgba(255, 255, 255, .06);
      border: 1px solid rgba(121, 198, 255, .5);
      pointer-events: auto
    }

    .knob {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 56px;
      height: 56px;
      margin-left: -28px;
      margin-top: -28px;
      border-radius: 50%;
      background: rgba(121, 198, 255, .3);
      border: 1px solid rgba(121, 198, 255, .8)
    }

    .thrBox {
      position: absolute;
      right: 12px;
      bottom: 12px;
      width: 150px;
      pointer-events: auto
    }

    .track {
      position: relative;
      width: 48px;
      height: 160px;
      margin: 0 auto;
      background: rgba(255, 255, 255, .06);
      border: 1px solid rgba(255, 120, 50, .5);
      border-radius: 12px
    }

    .fill {
      position: absolute;
      left: 4px;
      right: 4px;
      bottom: 4px;
      height: 0;
      background: linear-gradient(180deg, rgba(255, 210, 90, .9), rgba(255, 120, 50, .9));
      border-radius: 10px
    }

    .knot {
      position: absolute;
      left: 50%;
      width: 56px;
      height: 24px;
      margin-left: -28px;
      background: rgba(255, 255, 255, .2);
      border: 1px solid rgba(255, 255, 255, .5);
      border-radius: 8px;
      transform: translateY(-12px)
    }

    .trow {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-top: 8px
    }

    .tbtn {
      pointer-events: auto;
      padding: 8px 12px;
      border-radius: 10px;
      background: rgba(255, 255, 255, .1);
      border: 1px solid rgba(255, 255, 255, .25)
    }

    .tbtn.warn {
      background: rgba(255, 120, 50, .18);
      border-color: rgba(255, 120, 50, .45)
    }
  </style>
</head>

<body>
  <div id="wrap">
    <canvas id="c"></canvas>

    <div class="hud">A/D rotasi • W/S maju/mundur • SHIFT boost • SPACE respawn<br><span id="stat"></span></div>
    <div class="badge" id="ver"></div>

    <div class="menu">
      <div class="btn" id="mBtn">☰ Pengaturan</div>
      <div class="panel" id="panel">
        <div class="row"><label>Massa</label><input id="mass" type="range" min="40" max="280" value="120">
          <div id="massv">120</div>
        </div>
        <div class="row"><label>Spin</label><input id="spin" type="range" min="0" max="1" step="0.01" value="0.5">
          <div id="spinv">0.50</div>
        </div>
        <div class="row"><label>Kecerahan</label><input id="bright" type="range" min="0" max="1" step="0.01"
            value="0.7">
          <div id="brv">0.70</div>
        </div>
        <div class="tog"><input id="nebula" type="checkbox"> Nebula (lebih berat)</div>
        <div class="tog"><input id="helper" type="checkbox" checked> Orbit helper</div>
      </div>
    </div>

    <!-- touch controls -->
    <div class="touch" id="touch">
      <div class="joy" id="joy">
        <div class="knob" id="knob"></div>
      </div>
      <div class="thrBox">
        <div class="track" id="track">
          <div class="fill" id="fill"></div>
          <div class="knot" id="knot"></div>
        </div>
        <div class="trow">
          <div class="tbtn warn" id="bBoost">BOOST</div>
          <div class="tbtn" id="bRev">REV</div>
          <div class="tbtn" id="bResp">RESP</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      // ===== Version & params
      var ver = document.getElementById('ver');
      var params = new URLSearchParams(location.search);
      var STAMP = new Date().toLocaleString();
      ver.textContent = 'Stable ' + STAMP;

      var FORCE_LITE = params.get('lite') === '1';
      var FORCE_TOUCH = params.get('touch') === '1';
      var FPS = Math.min(Math.max(parseInt(params.get('fps') || '30', 10), 15), 60); // default 30

      // ===== Canvas
      var canvas = document.getElementById('c'), ctx = canvas.getContext('2d', { alpha: false });
      var DPR = Math.min(1.5, window.devicePixelRatio || 1); // batasi DPR biar ringan
      var W = 0, H = 0;
      function resize() {
        W = canvas.width = Math.floor(window.innerWidth * DPR);
        H = canvas.height = Math.floor(window.innerHeight * DPR);
        canvas.style.width = window.innerWidth + 'px';
        canvas.style.height = window.innerHeight + 'px';
        rebuild();
      }
      addEventListener('resize', resize);

      // ===== UI
      var panel = document.getElementById('panel'), mBtn = document.getElementById('mBtn'), open = false;
      mBtn.addEventListener('click', function () { open = !open; panel.style.display = open ? 'block' : 'none'; });

      var mass = document.getElementById('mass'), massv = document.getElementById('massv');
      var spin = document.getElementById('spin'), spinv = document.getElementById('spinv');
      var bright = document.getElementById('bright'), brv = document.getElementById('brv');
      var nebulaT = document.getElementById('nebula');
      var helperT = document.getElementById('helper');
      function sync() { massv.textContent = mass.value; spinv.textContent = (+spin.value).toFixed(2); brv.textContent = (+bright.value).toFixed(2); rebuild(); }
      ;[mass, spin, bright, nebulaT, helperT].forEach(el => el.addEventListener('input', sync));

      // ===== Touch detection & controls
      var isTouch = FORCE_TOUCH || ('ontouchstart' in window) || navigator.maxTouchPoints > 0 || innerWidth < 1024;
      var touch = document.getElementById('touch'); touch.style.display = isTouch ? 'block' : 'none';
      var joy = document.getElementById('joy'), knob = document.getElementById('knob');
      var track = document.getElementById('track'), fill = document.getElementById('fill'), knot = document.getElementById('knot');

      var joyX = 0, thr = 0, revHold = false, boostHold = false;
      function bindJoystick() {
        var active = false, id = null, cx = 0, cy = 0, rad = 60;
        function setPos(x, y) {
          var r = joy.getBoundingClientRect(); cx = r.left + r.width / 2; cy = r.top + r.height / 2;
          var dx = x - cx, dy = y - cy, d = Math.hypot(dx, dy); if (d > rad) { dx = dx / d * rad; dy = dy / d * rad; }
          joyX = dx / rad; knob.style.transform = 'translate(' + dx + 'px,' + dy + 'px)';
        }
        function end(e) { if (active && (!e || e.pointerId === id)) { try { joy.releasePointerCapture(id); } catch (_) { } active = false; joyX = 0; knob.style.transform = 'translate(0,0)'; } }
        joy.addEventListener('pointerdown', e => { active = true; id = e.pointerId; joy.setPointerCapture(id); setPos(e.clientX, e.clientY); e.preventDefault(); }, { passive: false });
        joy.addEventListener('pointermove', e => { if (!active || e.pointerId !== id) return; setPos(e.clientX, e.clientY); e.preventDefault(); }, { passive: false });
        joy.addEventListener('pointerup', end); joy.addEventListener('pointercancel', end); joy.addEventListener('lostpointercapture', () => { active = false; joyX = 0; knob.style.transform = 'translate(0,0)'; });
      }
      function bindThrottle() {
        var active = false, id = null, rect = null;
        function setY(y) {
          var top = rect.top + 6, bot = rect.bottom - 6, h = bot - top; var v = Math.max(0, Math.min(1, (bot - y) / h));
          thr = v; fill.style.height = (v * 100) + '%'; knot.style.top = ((1 - v) * h + 6) + 'px';
        }
        function end(e) { if (active && (!e || e.pointerId === id)) { try { track.releasePointerCapture(id); } catch (_) { } active = false; } }
        track.addEventListener('pointerdown', e => { active = true; id = e.pointerId; track.setPointerCapture(id); rect = track.getBoundingClientRect(); setY(e.clientY); e.preventDefault(); }, { passive: false });
        track.addEventListener('pointermove', e => { if (!active || e.pointerId !== id) return; setY(e.clientY); e.preventDefault(); }, { passive: false });
        track.addEventListener('pointerup', end); track.addEventListener('pointercancel', end); track.addEventListener('lostpointercapture', () => { active = false; });
      }
      function bindButtons() {
        function hold(btn, cb) {
          btn.addEventListener('pointerdown', e => { btn.setPointerCapture(e.pointerId); cb(true); e.preventDefault(); }, { passive: false });
          function up(e) { cb(false); try { btn.releasePointerCapture(e.pointerId); } catch (_) { } }
          btn.addEventListener('pointerup', up); btn.addEventListener('pointercancel', up); btn.addEventListener('lostpointercapture', () => cb(false));
        }
        hold(document.getElementById('bRev'), v => revHold = v);
        hold(document.getElementById('bBoost'), v => boostHold = v);
        document.getElementById('bResp').addEventListener('click', () => respawn());
      }
      if (isTouch) { bindJoystick(); bindThrottle(); bindButtons(); }

      // ===== Scene (ringan)
      var cfg = { starCount: FORCE_LITE ? 180 : 300, diskLayers: FORCE_LITE ? 8 : 10 };
      var stars = [], puffs = [];
      function rebuild() { buildStars(); buildNebula(); }
      function buildStars() { stars.length = 0; for (var i = 0; i < cfg.starCount; i++) stars.push({ x: Math.random() * W, y: Math.random() * H, r: (Math.random() * 1 + 0.2) * DPR, a: 0.4 + Math.random() * 0.5, t: Math.random() * 6.28 }); }
      function drawStars(t) { ctx.save(); for (var i = 0; i < stars.length; i++) { var s = stars[i]; var tw = 0.85 + 0.15 * Math.sin(t * 1.2 + s.t); ctx.beginPath(); ctx.fillStyle = 'rgba(180,200,255,' + (s.a * tw) + ')'; ctx.arc(s.x, s.y, 1.5 * s.r, 0, Math.PI * 2); ctx.fill(); } ctx.restore(); }
      function buildNebula() { puffs.length = 0; for (var i = 0; i < 6; i++) puffs.push({ x: Math.random() * W, y: Math.random() * H, r: (150 + Math.random() * 350) * DPR, a: 0.02 + Math.random() * 0.05, s: (0.1 + Math.random() * 0.3) * (Math.random() < .5 ? -1 : 1) }); }
      function drawNebula(t) { if (!nebulaT.checked) return; ctx.save(); for (var i = 0; i < puffs.length; i++) { var p = puffs[i]; var rr = p.r * (1 + 0.02 * Math.sin(t * 0.25 + p.x * 0.0004)); ctx.fillStyle = 'rgba(90,140,255,' + p.a + ')'; ctx.beginPath(); ctx.arc(p.x, p.y, rr, 0, Math.PI * 2); ctx.fill(); p.x += p.s; if (p.x < -rr) p.x = W + rr; if (p.x > W + rr) p.x = -rr; } ctx.restore(); }

      // ===== Black hole render (disk layer sedikit + tanpa compositing berat)
      function drawBH(cx, cy, t) {
        var rH = (+mass.value) * DPR, spinRate = 0.2 + (+spin.value) * 1.4, glow = (+bright.value);
        // background vignette ringan
        ctx.fillStyle = '#000'; ctx.fillRect(0, 0, W, H);

        // disk sederhana (stroke oranye)
        var L = cfg.diskLayers;
        for (var i = 0; i < L; i++) {
          var p = i / (L - 1);
          var rad = rH * 1.1 + p * rH * 2.0;
          var w = Math.max(3 * DPR, rH * 0.045 * (1.6 - p));
          ctx.save(); ctx.translate(cx, cy); ctx.rotate(t * spinRate * (1.1 - p * 0.8));
          for (var h = 0; h < 2; h++) {
            var alpha = (1 - p) * (0.28 + 0.5 * glow) * (h === 0 ? 1.35 : 1);
            ctx.beginPath();
            ctx.strokeStyle = 'rgba(255,150,80,' + alpha + ')';
            ctx.lineWidth = w; ctx.lineCap = 'round';
            var span = Math.PI * 0.72; var sgn = h === 0 ? 1 : -1;
            ctx.arc(0, 0, rad, -span * sgn, 0 * sgn);
            ctx.stroke();
          }
          ctx.restore();
        }

        // rim ringan
        ctx.beginPath(); ctx.strokeStyle = 'rgba(255,120,50,' + (0.18 + 0.25 * glow) + ')'; ctx.lineWidth = Math.max(2 * DPR, rH * 0.06);
        ctx.arc(cx, cy, rH * 1.25, 0, Math.PI * 2); ctx.stroke();

        // event horizon
        ctx.beginPath(); ctx.fillStyle = '#000'; ctx.arc(cx, cy, rH, 0, Math.PI * 2); ctx.fill();

        return { rs: rH };
      }

      // ===== Physics (semi-implicit Euler: ringan & stabil)
      function accelPW(cx, cy, x, y, GM, rs, spinK) {
        var dx = cx - x, dy = cy - y; var r = Math.hypot(dx, dy); r = Math.max(rs * 1.02, r);
        var inv = 1 / r, rmr = r - rs, mag = GM / (rmr * rmr);
        var ax = (dx * inv) * mag, ay = (dy * inv) * mag;
        var px = -dy * inv, py = dx * inv; var at = spinK * GM * (rs / (r * r * r)); // frame-dragging sederhana
        ax += px * at; ay += py * at;
        return { ax: ax, ay: ay, r: r };
      }

      // ===== Player
      var P = { x: 0, y: 0, vx: 0, vy: 0, angle: Math.PI };
      function respawn() { P.x = W * 0.78; P.y = H * 0.32; P.vx = P.vy = 0; P.angle = Math.PI; }
      var keys = new Set();
      addEventListener('keydown', e => { var k = e.key.toLowerCase(); if (['w', 'a', 's', 'd', 'shift', 'arrowup', 'arrowdown', 'arrowleft', 'arrowright', ' '].includes(k)) e.preventDefault(); keys.add(k); if (k === ' ') respawn(); });
      addEventListener('keyup', e => keys.delete(e.key.toLowerCase()));

      // ===== Orbit helper (40 step)
      function predict(cx, cy, GM, rs, spinK, tx, ty) {
        if (!helperT.checked) return;
        var steps = 40, dt = 1 / 60;
        var x = P.x, y = P.y, vx = P.vx, vy = P.vy;
        ctx.save(); ctx.beginPath(); ctx.moveTo(x, y);
        for (var i = 0; i < steps; i++) {
          var a = accelPW(cx, cy, x, y, GM, rs, spinK);
          vx += (a.ax + tx) * dt; vy += (a.ay + ty) * dt; x += vx * dt; y += vy * dt;
          ctx.lineTo(x, y);
          if (Math.hypot(cx - x, cy - y) <= rs) break;
        }
        ctx.strokeStyle = 'rgba(255,200,160,.5)'; ctx.lineWidth = 1 * DPR; ctx.stroke(); ctx.restore();
      }

      // ===== Main loop dengan FPS cap
      var stat = document.getElementById('stat');
      resize(); sync(); respawn();

      var last = 0, minDelta = 1000 / FPS;
      function frame(ts) {
        if (ts - last < minDelta) { requestAnimationFrame(frame); return; }
        var dt = Math.min(0.033, (ts - last) / 1000 || (1 / FPS));
        last = ts;

        // clear
        ctx.clearRect(0, 0, W, H);

        // scene
        var t = ts / 1000, cx = W * 0.5, cy = H * 0.52;
        drawNebula(t); drawStars(t);
        var bh = drawBH(cx, cy, t);

        // controls
        var turn = 0; if (keys.has('a') || keys.has('arrowleft')) turn -= 1; if (keys.has('d') || keys.has('arrowright')) turn += 1;
        turn += joyX; if (turn > 1) turn = 1; if (turn < -1) turn = -1;

        var forward = 0; if (keys.has('w') || keys.has('arrowup')) forward += 1; if (keys.has('s') || keys.has('arrowdown')) forward -= 1;
        forward += thr; if (revHold) forward -= 1;
        var boosting = keys.has('shift') || boostHold;

        var turnSpeed = 2.6; P.angle += turnSpeed * turn * dt;

        // physics
        var GM = (+mass.value) * 240, spinK = (+spin.value) * 3.0;
        var thrust = Math.max(-1, Math.min(1, forward)) * (120 * DPR) * (boosting ? 1.8 : 1);
        var tx = Math.cos(P.angle) * thrust, ty = Math.sin(P.angle) * thrust;

        predict(cx, cy, GM, bh.rs, spinK, tx, ty);

        var a = accelPW(cx, cy, P.x, P.y, GM, bh.rs, spinK);
        P.vx += (a.ax + tx) * dt;
        P.vy += (a.ay + ty) * dt;
        P.x += P.vx * dt;
        P.y += P.vy * dt;

        // border bounce
        var pad = 2 * DPR, b = 0.6;
        if (P.x < 0) { P.x = pad; P.vx = Math.abs(P.vx) * b; }
        if (P.x > W) { P.x = W - pad; P.vx = -Math.abs(P.vx) * b; }
        if (P.y < 0) { P.y = pad; P.vy = Math.abs(P.vy) * b; }
        if (P.y > H) { P.y = H - pad; P.vy = -Math.abs(P.vy) * b; }

        // rocket
        var pr = 10 * DPR, L = pr * 2.3, R = pr * 0.7;
        ctx.save(); ctx.translate(P.x, P.y); ctx.rotate(P.angle);
        ctx.beginPath(); ctx.moveTo(L * 0.55, 0);
        ctx.quadraticCurveTo(L * 0.08, -R, -L * 0.4, -R * 0.7);
        ctx.lineTo(-L * 0.4, R * 0.7);
        ctx.quadraticCurveTo(L * 0.08, R, L * 0.55, 0);
        ctx.closePath(); ctx.fillStyle = 'rgba(240,245,255,.95)'; ctx.fill();
        ctx.beginPath(); ctx.arc(L * 0.15, 0, R * 0.35, 0, Math.PI * 2); ctx.fillStyle = 'rgba(40,60,100,.9)'; ctx.fill();
        // api ringan (compositing minimal)
        var v = Math.hypot(P.vx, P.vy);
        if (thrust !== 0 || v > 60) {
          var fl = L * 0.5 + v * 0.05 + (thrust > 0 ? pr * 0.7 : 0);
          var g = ctx.createLinearGradient(-L * 0.45, 0, -fl, 0);
          g.addColorStop(0, 'rgba(255,210,90,.95)'); g.addColorStop(1, 'rgba(80,180,255,0)');
          ctx.beginPath(); ctx.moveTo(-L * 0.4, -R * 0.3); ctx.lineTo(-fl, 0); ctx.lineTo(-L * 0.4, R * 0.3); ctx.closePath();
          ctx.fillStyle = g; var old = ctx.globalCompositeOperation; ctx.globalCompositeOperation = 'lighter'; ctx.fill(); ctx.globalCompositeOperation = old;
        }
        ctx.restore();

        // stats
        stat.textContent = 'FPS~' + Math.round(1000 / (ts - last + 1)) + ' | DPR:' + DPR.toFixed(2) + ' | Stars:' + stars.length + ' | Layers:' + cfg.diskLayers;

        requestAnimationFrame(frame);
      }
      requestAnimationFrame(frame);

    })();
  </script>
</body>

</html>kground:rgba(0,0,0,.35);padding:6px 8px;border-radius:8px;border:1px solid rgba(255,255,255,.08)}
  .menu{position:absolute;right:10px;top:10px;z-index:6}
  .btn{padding:6px 10px;border-radius:10px;background:rgba(12,18,28,.8);border:1px solid rgba(255,255,255,.15);cursor:pointer}
  .panel{margin-top:8px;background:rgba(10,10,20,.85);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:8px;display:none;width:min(360px,92vw)}
  .row{display:grid;grid-template-columns:1fr 70px;gap:8px;align-items:center;margin:6px 0}
  .row input[type=range]{-webkit-appearance:none;width:100%;height:6px;border-radius:999px;background:linear-gradient(90deg,#79c6ff,#aabfff);outline:none}
  .tog{display:flex;gap:8px;align-items:center;font-size:12px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);padding:6px 8px;border-radius:10px}
  /* Touch controls */
  .touch{position:absolute;inset:0;z-index:4;pointer-events:none}
  .joy{position:absolute;left:12px;bottom:12px;width:140px;height:140px;border-radius:50%;background:rgba(255,255,255,.06);border:1px solid rgba(121,198,255,.5);pointer-events:auto}
  .knob{position:absolute;left:50%;top:50%;width:56px;height:56px;margin-left:-28px;margin-top:-28px;border-radius:50%;background:rgba(121,198,255,.3);border:1px solid rgba(121,198,255,.8)}
  .thrBox{position:absolute;right:12px;bottom:12px;width:150px;pointer-events:auto}
  .track{position:relative;width:48px;height:160px;margin:0 auto;background:rgba(255,255,255,.06);border:1px solid rgba(255,120,50,.5);border-radius:12px}
  .fill{position:absolute;left:4px;right:4px;bottom:4px;height:0;background:linear-gradient(180deg,rgba(255,210,90,.9),rgba(255,120,50,.9));border-radius:10px}
  .knot{position:absolute;left:50%;width:56px;height:24px;margin-left:-28px;background:rgba(255,255,255,.2);border:1px solid rgba(255,255,255,.5);border-radius:8px;transform:translateY(-12px)}
  .trow{display:flex;gap:8px;justify-content:center;margin-top:8px}
  .tbtn{pointer-events:auto;padding:8px 12px;border-radius:10px;background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.25)}
  .tbtn.warn{background:rgba(255,120,50,.18);border-color:rgba(255,120,50,.45)}
  .badge{position:absolute;left:10px;top:42px;z-index:5;font-size:11px;background:#1b2333;color:#cfe9ff;border:1px solid rgba(121,198,255,.4);padding:3px 6px;border-radius:8px}
</style>
</head>
<body>
<div id="wrap">
  <canvas id="c"></canvas>

  <div class="hud" id="hud">A/D rotasi • W/S maju/mundur • SHIFT boost • SPACE respawn<br><span id="stat"></span></div>
  <div class="badge" id="ver"></div>

  <div class="menu">
    <div class="btn" id="mBtn">☰ Pengaturan</div>
    <div class="panel" id="panel">
      <div class="row"><label>Massa</label><input id="mass" type="range" min="40" max="280" value="120"><div id="massv">120</div></div>
      <div class="row"><label>Spin</label><input id="spin" type="range" min="0" max="1" step="0.01" value="0.5"><div id="spinv">0.50</div></div>
      <div class="row"><label>Kecerahan</label><input id="bright" type="range" min="0" max="1" step="0.01" value="0.7"><div id="brv">0.70</div></div>
      <div class="tog"><input id="nebula" type="checkbox"> Nebula (berat) </div>
      <div class="tog"><input id="helper" type="checkbox" checked> Orbit helper </div>
      <div class="tog"><input id="lite" type="checkbox"> Force Lite Mode </div>
    </div>
  </div>

  <!-- touch controls -->
  <div class="touch" id="touch">
    <div class="joy" id="joy"><div class="knob" id="knob"></div></div>
    <div class="thrBox">
      <div class="track" id="track"><div class="fill" id="fill"></div><div class="knot" id="knot"></div></div>
      <div class="trow"><div class="tbtn warn" id="bBoost">BOOST</div><div class="tbtn" id="bRev">REV</div><div class="tbtn" id="bResp">RESP</div></div>
    </div>
  </div>
</div>

<script>
(function(){
  // ===== Version badge
  var ver = document.getElementById('ver');
  ver.textContent = 'Lite ' + new Date().toLocaleTimeString();

  // ===== Canvas
  var canvas = document.getElementById('c'), ctx = canvas.getContext('2d');
  var DPR = Math.min(1.25, window.devicePixelRatio||1); // cap DPR untuk HP
  var W=0,H=0; function resize(){ W=canvas.width=Math.floor(innerWidth*DPR); H=canvas.height=Math.floor(innerHeight*DPR); canvas.style.width=innerWidth+'px'; canvas.style.height=innerHeight+'px'; rebuild(); }
  addEventListener('resize', resize);

  // ===== UI
  var panel=document.getElementById('panel'), mBtn=document.getElementById('mBtn'), open=false;
  mBtn.addEventListener('click', function(){ open=!open; panel.style.display=open?'block':'none'; });
  var mass = document.getElementById('mass'), massv=document.getElementById('massv');
  var spin = document.getElementById('spin'), spinv=document.getElementById('spinv');
  var bright = document.getElementById('bright'), brv=document.getElementById('brv');
  var nebulaT = document.getElementById('nebula');
  var helperT = document.getElementById('helper');
  var liteT = document.getElementById('lite');
  var params = new URLSearchParams(location.search);
  if (params.get('lite')==='1') liteT.checked = true;

  function sync(){ massv.textContent=mass.value; spinv.textContent=(+spin.value).toFixed(2); brv.textContent=(+bright.value).toFixed(2); rebuild(); }
  ;[mass,spin,bright,nebulaT,helperT,liteT].forEach(el=>el.addEventListener('input', sync));

  // ===== Touch detection + controls
  var isTouch = liteT.checked || ('ontouchstart' in window) || navigator.maxTouchPoints>0 || innerWidth<1024;
  var touch = document.getElementById('touch'); touch.style.display = isTouch?'block':'none';

  var joy=document.getElementById('joy'), knob=document.getElementById('knob');
  var track=document.getElementById('track'), fill=document.getElementById('fill'), knot=document.getElementById('knot');
  var joyX=0, joyY=0, thr=0, revHold=false, boostHold=false;

  function bindJoystick(){
    var active=false,id=null,cx=0,cy=0,rad=60;
    function setPos(x,y){
      var r = joy.getBoundingClientRect(); cx=r.left+r.width/2; cy=r.top+r.height/2;
      var dx=x-cx, dy=y-cy, d=Math.hypot(dx,dy); if(d>rad){ dx=dx/d*rad; dy=dy/d*rad; }
      joyX = dx/rad; joyY = dy/rad; knob.style.transform='translate('+dx+'px,'+dy+'px)';
    }
    function end(e){ if(active && (!e || e.pointerId===id)){ try{joy.releasePointerCapture(id);}catch{} active=false; joyX=0; joyY=0; knob.style.transform='translate(0,0)'; } }
    joy.addEventListener('pointerdown',e=>{active=true; id=e.pointerId; joy.setPointerCapture(id); setPos(e.clientX,e.clientY); e.preventDefault();},{passive:false});
    joy.addEventListener('pointermove',e=>{ if(!active||e.pointerId!==id) return; setPos(e.clientX,e.clientY); e.preventDefault(); },{passive:false});
    joy.addEventListener('pointerup',end); joy.addEventListener('pointercancel',end); joy.addEventListener('lostpointercapture',()=>{active=false;joyX=0;joyY=0;knob.style.transform='translate(0,0)';});
  }
  function bindThrottle(){
    var active=false,id=null,rect=null;
    function setY(y){
      var top=rect.top+6, bot=rect.bottom-6, h=bot-top; var v=Math.max(0,Math.min(1,(bot-y)/h));
      thr=v; fill.style.height=(v*100)+'%'; knot.style.top=((1-v)*h+6)+'px';
    }
    function end(e){ if(active && (!e||e.pointerId===id)){ try{track.releasePointerCapture(id);}catch{} active=false; } }
    track.addEventListener('pointerdown', e=>{active=true; id=e.pointerId; track.setPointerCapture(id); rect=track.getBoundingClientRect(); setY(e.clientY); e.preventDefault();},{passive:false});
    track.addEventListener('pointermove', e=>{ if(!active||e.pointerId!==id) return; setY(e.clientY); e.preventDefault(); },{passive:false});
    track.addEventListener('pointerup', end); track.addEventListener('pointercancel', end); track.addEventListener('lostpointercapture',()=>{active=false;});
  }
  function bindButtons(){
    function hold(btn,cb){ btn.addEventListener('pointerdown',e=>{btn.setPointerCapture(e.pointerId); cb(true); e.preventDefault();},{passive:false});
      function up(e){ cb(false); try{btn.releasePointerCapture(e.pointerId);}catch{} }
      btn.addEventListener('pointerup',up); btn.addEventListener('pointercancel',up); btn.addEventListener('lostpointercapture',()=>cb(false));}
    hold(document.getElementById('bRev'), v=>revHold=v);
    hold(document.getElementById('bBoost'), v=>boostHold=v);
    document.getElementById('bResp').addEventListener('click', ()=>respawn());
  }
  if(isTouch){ bindJoystick(); bindThrottle(); bindButtons(); }

  // ===== Scene data (lite)
  var stars=[], puffs=[];
  var cfg = { starCount: 300, diskLayers: 16 };
  function rebuild(){ buildStars(); buildNebula(); }
  function buildStars(){ stars.length=0; for(var i=0;i<cfg.starCount;i++) stars.push({x:Math.random()*W,y:Math.random()*H,r:(Math.random()*1+0.2)*DPR,a:0.4+Math.random()*0.5,t:Math.random()*6.28}); }
  function drawStars(t){ ctx.save(); ctx.globalCompositeOperation='screen'; for(var i=0;i<stars.length;i++){var s=stars[i]; var tw=0.8+0.2*Math.sin(t*1.2+s.t); var g=ctx.createRadialGradient(s.x,s.y,0,s.x,s.y,2.2*s.r); g.addColorStop(0,'rgba(180,200,255,'+(s.a*tw)+')'); g.addColorStop(1,'rgba(0,0,0,0)'); ctx.fillStyle=g; ctx.beginPath(); ctx.arc(s.x,s.y,2.2*s.r,0,Math.PI*2); ctx.fill(); } ctx.restore(); }
  function buildNebula(){ puffs.length=0; for(var i=0;i<10;i++) puffs.push({x:Math.random()*W,y:Math.random()*H,r:(150+Math.random()*350)*DPR,a:0.02+Math.random()*0.05,s:(0.1+Math.random()*0.3)*(Math.random()<.5?-1:1)}); }
  function drawNebula(t){ if(!nebulaT.checked) return; ctx.save(); ctx.globalCompositeOperation='screen'; for(var i=0;i<puffs.length;i++){var p=puffs[i]; var rr=p.r*(1+0.02*Math.sin(t*0.25+p.x*0.0004)); var g=ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,rr); g.addColorStop(0,'hsla('+(200+60*Math.sin(p.x*.0005+p.y*.0003))+',85%,65%,'+p.a+')'); g.addColorStop(1,'rgba(0,0,0,0)'); ctx.fillStyle=g; ctx.beginPath(); ctx.arc(p.x,p.y,rr,0,Math.PI*2); ctx.fill(); p.x+=p.s; if(p.x<-rr) p.x=W+rr; if(p.x>W+rr) p.x=-rr; } ctx.restore(); }

  // ===== Black hole render (lite)
  function drawBH(cx,cy,t){
    var rH=(+mass.value)*DPR, spinRate=0.2+(+spin.value)*1.6, glow=(+bright.value);
    var vg=ctx.createRadialGradient(cx,cy,rH*0.2,cx,cy,Math.max(W,H)*0.6); vg.addColorStop(0,'#000'); vg.addColorStop(1,'rgba(0,0,0,0)'); ctx.fillStyle=vg; ctx.fillRect(0,0,W,H);
    var L=cfg.diskLayers;
    for(var i=0;i<L;i++){ var p=i/(L-1); var rad=rH*1.1 + p*rH*2.2; var w=Math.max(4*DPR, rH*0.05*(1.6-p));
      ctx.save(); ctx.translate(cx,cy); ctx.rotate(t*spinRate*(1.15-p*0.85));
      for(var h=0;h<2;h++){ var alpha=(1-p)*(0.3+0.6*glow)*(h===0?1.5:1); ctx.beginPath(); ctx.strokeStyle='rgba(255,150,80,'+alpha+')'; ctx.lineWidth=w; ctx.lineCap='round'; var span=Math.PI*0.72*(liteT.checked?0.9:1); var sgn=h===0?1:-1; ctx.arc(0,0,rad,-span*sgn,0*sgn); ctx.globalCompositeOperation='lighter'; ctx.stroke(); }
      ctx.restore();
    }
    var rim=ctx.createRadialGradient(cx,cy,rH*0.95,cx,cy,rH*1.3); rim.addColorStop(0,'rgba(255,255,255,0)'); rim.addColorStop(1,'rgba(255,120,50,'+(0.18+0.28*glow)+')'); ctx.globalCompositeOperation='screen'; ctx.beginPath(); ctx.fillStyle=rim; ctx.arc(cx,cy,rH*1.3,0,Math.PI*2); ctx.fill(); ctx.globalCompositeOperation='source-over';
    ctx.beginPath(); ctx.fillStyle='#000'; ctx.arc(cx,cy,rH,0,Math.PI*2); ctx.fill();
    return {rs:rH};
  }

  // ===== Physics (Paczynski–Wiita + RK4, fixed step)
  function accelPW(cx,cy,x,y,GM,rs,spinK){ var dx=cx-x, dy=cy-y; var r=Math.hypot(dx,dy); r=Math.max(rs*1.02,r); var inv=1/r, rmr=r-rs, mag=GM/(rmr*rmr); var ax=(dx*inv)*mag, ay=(dy*inv)*mag; var px=-dy*inv, py=dx*inv; var at=spinK*GM*(rs/(r*r*r)); ax+=px*at; ay+=py*at; return {ax:ax,ay:ay,r:r}; }
  function rk4(s,dt,p){ function f(u){ var a=accelPW(p.cx,p.cy,u.x,u.y,p.GM,p.rs,p.spinK); return {xd:u.vx, yd:u.vy, vxd:a.ax+p.tx, vyd:a.ay+p.ty}; }
    var k1=f(s), k2=f({x:s.x+0.5*dt*k1.xd,y:s.y+0.5*dt*k1.yd,vx:s.vx+0.5*dt*k1.vxd,vy:s.vy+0.5*dt*k1.vyd});
    var k3=f({x:s.x+0.5*dt*k2.xd,y:s.y+0.5*dt*k2.yd,vx:s.vx+0.5*dt*k2.vxd,vy:s.vy+0.5*dt*k2.vyd});
    var k4=f({x:s.x+dt*k3.xd,y:s.y+dt*k3.yd,vx:s.vx+dt*k3.vxd,vy:s.vy+dt*k3.vyd});
    return {x:s.x+(dt/6)*(k1.xd+2*k2.xd+2*k3.xd+k4.xd), y:s.y+(dt/6)*(k1.yd+2*k2.yd+2*k3.yd+k4.yd), vx:s.vx+(dt/6)*(k1.vxd+2*k2.vxd+2*k3.vxd+k4.vxd), vy:s.vy+(dt/6)*(k1.vyd+2*k2.vyd+2*k3.vyd+k4.vyd)};
  }

  // ===== Player
  var P={x:0,y:0,vx:0,vy:0,angle:Math.PI}; function respawn(){ P.x=W*0.78; P.y=H*0.32; P.vx=P.vy=0; P.angle=Math.PI; }
  var keys=new Set(); addEventListener('keydown',e=>{var k=e.key.toLowerCase(); if(['w','a','s','d','shift','arrowup','arrowdown','arrowleft','arrowright',' '].includes(k)) e.preventDefault(); keys.add(k); if(k===' ') respawn();});
  addEventListener('keyup',e=>keys.delete(e.key.toLowerCase()));

  // ===== Orbit helper (lite)
  function predict(cx,cy,GM,rs,spinK,tx,ty){ if(!helperT.checked) return; var steps=60, dt=1/60, s={x:P.x,y:P.y,vx:P.vx,vy:P.vy};
    ctx.save(); ctx.globalAlpha=.9; ctx.beginPath(); ctx.moveTo(s.x,s.y);
    for(var i=0;i<steps;i++){ var a=accelPW(cx,cy,s.x,s.y,GM,rs,spinK); s.vx+=(a.ax+tx)*dt; s.vy+=(a.ay+ty)*dt; s.x+=s.vx*dt; s.y+=s.vy*dt; ctx.lineTo(s.x,s.y); if(Math.hypot(cx-s.x,cy-s.y)<=rs) break; }
    ctx.setLineDash([4*DPR,4*DPR]); ctx.strokeStyle='rgba(255,200,160,.5)'; ctx.lineWidth=1*DPR; ctx.stroke(); ctx.setLineDash([]); ctx.restore(); }

  // ===== Adaptive quality scaler
  var qTimer=0, qSamples=0, msAccum=0;
  function qualityTick(ms){ msAccum+=ms; qSamples++; if(qSamples>=20){ var avg=msAccum/qSamples;
      if(avg>24){ // berat → turunkan
        cfg.starCount=Math.max(120, Math.floor(cfg.starCount*0.85));
      }else if(avg<16){ // longgar → naik dikit
        cfg.starCount=Math.min(600, Math.floor(cfg.starCount*1.05));
      }
      buildStars(); qSamples=0; msAccum=0;
  }}

  // ===== Main loop (fixed timestep)
  var stat=document.getElementById('stat'); resize(); sync(); respawn();
  var last=performance.now(), acc=0, step=1/60;
  (function loop(now){
    var ms=now-last; last=now; acc+=ms/1000;
    // render
    ctx.clearRect(0,0,W,H);
    var cx=W*0.5, cy=H*0.52;
    drawNebula(now/1000); drawStars(now/1000);
    var bh=drawBH(cx,cy,now/1000);

    // controls
    var turnInput=0; if(keys.has('a')||keys.has('arrowleft')) turnInput-=1; if(keys.has('d')||keys.has('arrowright')) turnInput+=1; turnInput+=joyX; turnInput=Math.max(-1,Math.min(1,turnInput));
    var forward=0; if(keys.has('w')||keys.has('arrowup')) forward+=1; if(keys.has('s')||keys.has('arrowdown')) forward-=1; forward+=thr; if(revHold) forward-=1;
    var boosting = keys.has('shift') || boostHold;
    var turnSpeed=2.6; P.angle += turnSpeed*turnInput*step;

    // physics fixed steps
    var GM=(+mass.value)*240, spinK=(+spin.value)*3.0;
    var thrust = Math.max(-1,Math.min(1,forward)) * (120*DPR) * (boosting?1.8:1);
    var tx=Math.cos(P.angle)*thrust, ty=Math.sin(P.angle)*thrust;
    predict(cx,cy,GM,bh.rs,spinK,tx,ty);

    while(acc>=step){
      var nxt=rk4({x:P.x,y:P.y,vx:P.vx,vy:P.vy}, step, {cx:cx,cy:cy,GM:GM,rs:bh.rs,spinK:spinK,tx:tx,ty:ty});
      P=nxt; // bounce border
      var pad=2*DPR, b=0.6; if(P.x<0){P.x=pad;P.vx=Math.abs(P.vx)*b;} if(P.x>W){P.x=W-pad;P.vx=-Math.abs(P.vx)*b;}
      if(P.y<0){P.y=pad;P.vy=Math.abs(P.vy)*b;} if(P.y>H){P.y=H-pad;P.vy=-Math.abs(P.vy)*b;}
      acc-=step;
    }

    // rocket
    var r=Math.hypot(cx-P.x, cy-P.y), pr=10*DPR, L=pr*2.3, R=pr*0.7;
    ctx.save(); ctx.translate(P.x,P.y); ctx.rotate(P.angle);
    ctx.beginPath(); ctx.moveTo(L*0.55,0); ctx.quadraticCurveTo(L*0.08,-R,-L*0.4,-R*0.7); ctx.lineTo(-L*0.4,R*0.7); ctx.quadraticCurveTo(L*0.08,R,L*0.55,0); ctx.closePath(); ctx.fillStyle='rgba(240,245,255,.95)'; ctx.fill();
    ctx.beginPath(); ctx.arc(L*0.15,0,R*0.35,0,Math.PI*2); ctx.fillStyle='rgba(40,60,100,.9)'; ctx.fill();
    var v=Math.hypot(P.vx,P.vy); if(thrust!==0 || v>60){ var fl=L*0.5 + v*0.05 + (thrust>0?pr*0.7:0); var g=ctx.createLinearGradient(-L*0.45,0,-fl,0); g.addColorStop(0,'rgba(255,210,90,.95)'); g.addColorStop(1,'rgba(80,180,255,0)'); ctx.beginPath(); ctx.moveTo(-L*0.4,-R*0.3); ctx.lineTo(-fl,0); ctx.lineTo(-L*0.4,R*0.3); ctx.closePath(); ctx.fillStyle=g; ctx.globalCompositeOperation='lighter'; ctx.fill(); ctx.globalCompositeOperation='source-over'; }
    ctx.restore();

    // stats + quality
    stat.textContent = 'FPS~' + Math.round(1000/ms) + '  |  Stars:'+cfg.starCount+'  | DPR:'+DPR.toFixed(2);
    qualityTick(ms);

    requestAnimationFrame(loop);
  })(performance.now());

})();
</script>
</body>
</html>
